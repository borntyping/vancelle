{% extends "base.html" %}

{% from "components/controls.html" import control_work_update, control_work_delete, control_work_restore, control_work_permanently_delete, controls_remote %}
{% from "components/bulma.html" import search_field %}
{% from "components/layout.html" import header, subheader %}
{% from "components/metadata.html" import panel_details, sources_list %}
{% from "components/record/library_card.html" import panel_library_card %}

{% set details = work.resolve_details() %}
{% set title = ["Remote", details.title] %}

{% macro _control_change_shelf(work, details) %}
  <form
    method="post"
    action="{{ url_for('work.shelve', work_id=work.id) }}"
    hx-post="{{ url_for('work.shelve', work_id=work.id) }}"
    hx-trigger="input changed from:find select throttle:1000ms"
    data-loading-target="#shelf-loading"
    class="control">
    {{ form.csrf_token }}
    <div class="field has-addons">
      <div class="control">
        <div id="shelf-loading" class="button is-{{ work.shelf.value }}" data-loading-class="is-loading">
          <span class="icon"><ion-icon name="book-outline"></ion-icon></span>
        </div>
      </div>
      <div class="control">
        {{ form.shelf(placeholder=work.shelf) }}
      </div>
    </div>
    <noscript>
      <div class="field">
        <div class="control">
          <button class="button" type="submit">Change shelf</button>
        </div>
      </div>
    </noscript>
  </form>
{% endmacro %}

{% macro _section_work(work, details) %}
  {% set subtitle %}
    {{ work.info.noun_title }} with details from {{ p.no('remote', work.remotes|length) }}
  {% endset %}

  <section class="block">
    {% call header(details.title, subtitle) %}
      {{ _control_change_shelf(work, details) }}
      {% if work.deleted %}
        {{ control_work_permanently_delete(work, False) }}
        {{ control_work_restore(work, False) }}
      {% else %}
        {{ control_work_update(work, False) }}
        {{ control_work_delete(work, False) }}
      {% endif %}
    {% endcall %}
    <div class="columns x-has-fullheight-containers">
      <div class="column">
        {% call panel_details(id=work.id, details=details, properties=work.into_properties(), data=None) %}
        {% endcall %}
      </div>
      <div class="column">{{ panel_library_card(work=work) }}</div>
    </div>
  </section>
{% endmacro %}

{%- macro _section_remote(remote) -%}
  {% set remote_details = remote.into_details() %}
  <section class="block">
    {%- call subheader(remote_details.title, "{} {}".format(remote.info.noun_full, remote.id)) -%}
      {{ controls_remote(remote, candidate_work=None, show_attached_work=False) }}
    {% endcall %}
    <div class="columns x-has-fullheight-containers">
      <div class="column">
        {% call panel_details(id=remote.id, details=remote.into_details(), properties=remote.into_properties(), data=remote.data, colour=remote.info.colour) %}
        {% endcall %}
      </div>
    </div>
  </section>
{%- endmacro -%}

{% macro _section_search_remotes() %}
  {% set subclasses = Remote.filter_subclasses(can_search=True) %}
  <section class="block">
    {{ subheader('Search external sources for metadata', n('available source', subclasses|length)) }}
    <div class="columns is-multiline is-centered">
      {% for cls in subclasses %}
        <div class="column is-4 has-text-centered">
          <a href="{{ url_for('remote.search_source', remote_type=cls.remote_type(), work_id=work.id) }}" class="button is-{{ cls.info.colour }} is-fullwidth">
            Search {{ cls.info.full_plural }}
          </a>
        </div>
      {% endfor %}
    </div>
  </section>
{% endmacro %}

{% block content %}
  {{ _section_work(work, details) }}

  {% for remote in work.iter_remotes() %}
    {{ _section_remote(remote) }}
  {% endfor %}

  {{ _section_search_remotes() }}
{% endblock %}
